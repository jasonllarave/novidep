<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Novi - colombianoviolenta.org</title>
  <link rel="stylesheet" href="./index.css" />
</head>
<body>
  
  <div class="chat-container" id="chat-container" role="region" aria-label="Chat Novi" style="display: flex;">
    <div class="chat-header">
      <div>
        <h2>Novi</h2>
        <p>Asistencia para Visitas Colombia Noviolenta</p>
      </div>
      <button class="minimize-btn" id="minimize-btn" title="Minimizar">âˆ’</button>
    </div>

    <div class="messages-container" id="messages"></div>

    <div class="typing-indicator" id="typing" style="display:none;">
      <span></span><span></span><span></span>
    </div>

    <div class="input-container">
      <div class="input-wrapper">
        <input type="text" id="user-input" placeholder="Mensaje..." autocomplete="off" />
        <button class="send-button" id="send-btn">âž¤</button>
      </div>
    </div>
  </div>

  <script>
    const chatContainer = document.getElementById("chat-container");
    const minimizeBtn = document.getElementById("minimize-btn");
    const messagesContainer = document.getElementById("messages");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const typingIndicator = document.getElementById("typing");

    let SESSION_ID = localStorage.getItem("novi_session_id");
    if (!SESSION_ID) {
      SESSION_ID = "s_" + Date.now() + "_" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem("novi_session_id", SESSION_ID);
    }

    let isSending = false;
    let chatInitialized = false;

    function showTyping() {
      typingIndicator.style.display = "block";
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function hideTyping() {
      typingIndicator.style.display = "none";
    }

    function activateQuickButtons(container) {
      // âœ… Primero: botones con data-url (links externos)
      container.querySelectorAll(".quick-button[data-url]").forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener("click", function(e) {
          e.preventDefault();
          e.stopPropagation();
          const url = this.getAttribute("data-url");
          console.log("ðŸ”— Abriendo URL:", url);
          window.open(url, "_blank");
        });
      });

      // âœ… Segundo: botones con data-option (flujo conversacional)
      container.querySelectorAll(".quick-button[data-option]").forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener("click", function(e) {
          e.preventDefault();
          e.stopPropagation();
          const option = this.getAttribute("data-option");
          console.log("ðŸ”˜ OpciÃ³n clickeada:", option);
          
          if (option === "authorize") {
            sendAuthorization();
          } else {
            addMessage(this.textContent, true);
            sendToChatbot(option);
          }
        });
      });
    }

    function addMessage(content, isUser = false) {
      const div = document.createElement("div");
      div.classList.add("message", isUser ? "user-message" : "bot-message");
      div.innerHTML = content;
      messagesContainer.appendChild(div);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      setTimeout(() => activateQuickButtons(div), 50);
    }

    async function sendToChatbot(message) {
      if (isSending) {
        console.log("â³ Ya hay un envÃ­o en proceso");
        return;
      }
      
      isSending = true;
      console.log("ðŸ“¤ Enviando:", message);
      showTyping();

      try {
        const res = await fetch("/api/chatbot/chatbot", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, sessionId: SESSION_ID })
        });

        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        
        const data = await res.json();
        console.log("ðŸ“¥ Respuesta:", data);
        hideTyping();

        if (data.sessionId) {
          SESSION_ID = data.sessionId;
          localStorage.setItem("novi_session_id", SESSION_ID);
        }

        if (data.reply) {
          addMessage(data.reply);
        } else {
          addMessage("âš ï¸ No recibÃ­ respuesta del servidor");
        }
        
      } catch (err) {
        hideTyping();
        addMessage("âŒ Error: " + err.message);
        console.error("Error completo:", err);
      } finally {
        isSending = false;
      }
    }

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      addMessage(message, true);
      userInput.value = "";
      await sendToChatbot(message);
    }

    window.sendAuthorization = async function() {
      const checkbox = document.getElementById("authCheck");
      if (checkbox && !checkbox.checked) {
        alert("âš ï¸ Por favor marca la casilla de autorizaciÃ³n");
        return;
      }

      if (isSending) return;
      isSending = true;
      showTyping();

      try {
        const res = await fetch("/api/chatbot/authorize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionId: SESSION_ID })
        });

        const data = await res.json();
        hideTyping();
        addMessage(data.reply);
      } catch (err) {
        hideTyping();
        addMessage("âŒ Error procesando autorizaciÃ³n");
        console.error(err);
      } finally {
        isSending = false;
      }
    };

    minimizeBtn.addEventListener("click", () => {
      chatContainer.style.display = "none";
      if (window.parent !== window) {
        window.parent.postMessage({ action: 'closeChat' }, '*');
      }
    });

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", e => { 
      if (e.key === "Enter") sendMessage(); 
    });

    // ðŸ”¥ INICIALIZAR CHAT AUTOMÃTICAMENTE
    window.addEventListener('load', async () => {
      setTimeout(async () => {
        if (!chatInitialized) {
          chatInitialized = true;
          await sendToChatbot("start");
          userInput.focus();
        }
      }, 300);
    });

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('init') === 'start' && !chatInitialized) {
      chatInitialized = true;
      setTimeout(() => sendToChatbot("start"), 500);
    }
  </script>
</body>
</html>