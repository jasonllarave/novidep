<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novi - colombianoviolenta.org</title>
    <link rel="stylesheet" href="./index.css">
    <style>
        /* Estilo para la leyenda flotante */
        .novi-sign {
            position: fixed;
            bottom: 30px;
            right: 40px;
            background: #3c3f42;
            color: #fff;
            padding: 12px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 9999;
        }

        .chat-container {
            display: none; /* oculto por defecto */
            position: fixed;
            bottom: 60px;
            right: 40px;
            width: 550px;
            height: 700px;
            border: 1px solid #ccc;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            background: #fff;
            flex-direction: column;
            z-index: 9998;
        }
    </style>
</head>
<body>
    <!-- Leyenda que despliega el chat -->
    <div class="novi-sign" id="novi-sign">
        Soy Novi, estoy aquí para ayudarte
    </div>

    <!-- Contenedor del chat -->
    <div class="chat-container" id="chat-container">
        <div class="chat-header">
            <div>
                <h2>Novi</h2>
                <p>Asistencia para Visitas Colombianoviolenta</p>
            </div>
            <button class="minimize-btn" id="minimize-btn">−</button>
        </div>
        
        <div class="messages-container" id="messages">
            <div class="message bot-message">
                Hola, soy Novi, tu asistente virtual de Colombia Noviolenta.  
    Actualmente contamos con talleres, conferencias y espacios de orientación en Noviolencia.  
    ¿Te gustaría participar en nuestros eventos?  
    <br><br>
    Responde <strong>sí</strong> o <strong>no</strong>.
            </div>
        </div>
        
        <div class="typing-indicator" id="typing">
            <span></span>
            <span></span>
            <span></span>
        </div>
        
        <div class="input-container">
            <div class="quick-buttons">
                <button class="quick-button" onclick="sendQuickMessage('Boletas concierto')">Boletas concierto</button>
                <button class="quick-button" onclick="sendQuickMessage('Compras tienda')">Compras tienda</button>
                <button class="quick-button" onclick="sendQuickMessage('Adquirir servicios')">Adquirir servicios</button>
                <button class="quick-button" onclick="sendQuickMessage('Voluntariado y participación')">Voluntariado y participación</button>
                <button class="quick-button" onclick="sendQuickMessage('Donaciones')">Donaciones</button>
                <button class="quick-button" onclick="sendQuickMessage('Cartilla')">Cartilla</button>
            </div>
            
            <div class="input-wrapper">
                <input type="text" id="user-input" placeholder="Escribe tu mensaje..." autocomplete="off">
                <button class="send-button" id="send-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
            
            
        </div>
    </div>

    <script>
        const noviSign = document.getElementById('novi-sign');
        const chatContainer = document.getElementById('chat-container');
        const minimizeBtn = document.getElementById('minimize-btn');
        const messagesContainer = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const emergencyBtn = document.getElementById('emergency-btn');
        const typingIndicator = document.getElementById('typing');

        // Convierte URLs en enlaces clicables
        function formatLinks(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
        }

        function addMessage(content, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            messageDiv.classList.add(isUser ? 'user-message' : 'bot-message');
            messageDiv.innerHTML = isUser ? content : formatLinks(content);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            typingIndicator.style.display = 'block';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            typingIndicator.style.display = 'none';
        }

        function sendQuickMessage(topic) {
            userInput.value = topic;
            sendMessage();
        }





 
        // ======== MANEJO DE FLUJO DE PARTICIPACIÓN ========

window.participationState = null;
window.tempName = null;
window.tempPhone = null;

async function handleParticipationFlow(message) {
    const msg = message.toLowerCase();

    // → RESPUESTA "NO"
    if (msg === "no" && window.participationState === null) {
        addMessage(
            `
            ¡Gracias por responder! <br><br>
            Si deseas conocer más sobre nuestras plataformas y redes, aquí te dejo algunos enlaces:<br><br>
            <a href="https://www.colombianoviolenta.org" target="_blank"> Sitio Web Oficial</a><br>
            <a href="https://www.instagram.com/colombianoviolenta" target="_blank"> Instagram</a><br>
            <a href="https://www.facebook.com/colombianoviolenta" target="_blank"> Facebook</a><br>
            <a href="https://www.colombianoviolenta.org/tienda" target="_blank"> Tienda Online</a><br>
            `,
            false
        );
        return true; // indica que ya manejamos el flujo
    }

    // → RESPUESTA "SÍ"
    if ((msg === "si" || msg === "sí") && window.participationState === null) {
        addMessage("¡Excelente!  Por favor escribe tu nombre completo:", false);
        window.participationState = "name";
        return true;
    }

    // → CAPTURAR NOMBRE
    if (window.participationState === "name") {
        window.tempName = message;
        addMessage("Perfecto  Ahora escribe tu número de contacto:", false);
        window.participationState = "phone";
        return true;
    }

    // → CAPTURAR TELÉFONO
    if (window.participationState === "phone") {
        window.tempPhone = message;

        addMessage(
            `
            <div>
                Para continuar, por favor autoriza el uso de tus datos:<br><br>
                <label style="display:flex;align-items:center;gap:10px;">
                    <input type="checkbox" id="authCheck"> Autorizo el uso de mis datos
                </label>
                <button onclick="sendAuthorization()" 
                    style="margin-top:10px;background:#003cff;color:white;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;">
                    Enviar
                </button>
            </div>
            `,
            false
        );

        window.participationState = "authorize";
        return true;
    }

    return false; // no pertenece al flujo
}







        function sendMessage() {
    const message = userInput.value.trim();
    if (message === '') return;

    addMessage(message, true);
    userInput.value = '';

    // Primero revisar si el mensaje pertenece al flujo de participación
    handleParticipationFlow(message).then((handled) => {
        if (handled) return;

        // Si NO pertenece al flujo, enviar mensaje normal al backend
        showTypingIndicator();

        const API_URL = "https://novi-drekbmcchpc0g2gr.centralus-01.azurewebsites.net";

        fetch(`${API_URL}/api/chatbot/chatbot`, { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message })
        })
        .then((response) => response.json())
        .then((data) => {
            hideTypingIndicator();
            addMessage(data.reply);
        })
        .catch((error) => {
            hideTypingIndicator();
            addMessage("Error al comunicarse con el servidor.");
            console.error('Error:', error);
        });
    });
}





async function sendAuthorization() {
    const check = document.getElementById("authCheck");

    if (!check || !check.checked) {
        addMessage("Debes autorizar el uso de tus datos antes de continuar.", false);
        return;
    }

    const info = {
        name: window.tempName,
        phone: window.tempPhone,
        authorized: true
    };

    const res = await fetch("/api/register", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(info)
    });

    const data = await res.json();

    if (data.success) {
        addMessage("¡Gracias!  Tus datos fueron registrados. Muy pronto nos pondremos en contacto contigo.", false);
    } else {
        addMessage("Hubo un error guardando tu registro. Intenta nuevamente más tarde.", false);
    }

    window.participationState = null;
    window.tempName = null;
    window.tempPhone = null;
}







        function handleEmergency() {
            addMessage("Necesito orientación para eventos importantes");
            addMessage("como hago una compra");
        }

        // Mostrar chat al hacer clic en la leyenda
        noviSign.addEventListener('click', () => {
            chatContainer.style.display = 'flex';
            noviSign.style.display = 'none';
            userInput.focus();
        });

        // Minimizar chat y volver a mostrar la leyenda
        minimizeBtn.addEventListener('click', () => {
            chatContainer.style.display = 'none';
            noviSign.style.display = 'block';
        });

        sendBtn.addEventListener('click', sendMessage);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        emergencyBtn.addEventListener('click', handleEmergency);
    </script>
</body>
</html>
