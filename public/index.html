<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Novi - colombianoviolenta.org</title>
  <link rel="stylesheet" href="./index.css" />
  <style>
    .scroll-to-bottom {
      position: absolute;
      bottom: 80px;
      right: 20px;
      width: 40px;
      height: 40px;
      background: #3d3d443a;
      border: none;
      border-radius: 50%;
      color: white;
      font-size: 20px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      display: none;
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    .scroll-to-bottom:hover {
      background: #45a049;
      transform: scale(1.1);
    }
    
    .scroll-to-bottom.show {
      display: block;
      animation: bounce 0.5s ease;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .typing-effect {
      display: inline;
    }
  </style>
</head>
<body>
  
  <div class="chat-container" id="chat-container" role="region" aria-label="Chat Novi" style="display: flex;">
    <div class="chat-header">
      <div>
        <h2>Novi</h2>
        <p>Asistencia para Visitas Colombia Noviolenta</p>
      </div>
      <button class="minimize-btn" id="minimize-btn" title="Minimizar">‚àí</button>
    </div>

    <div class="messages-container" id="messages"></div>

    <div class="typing-indicator" id="typing" style="display:none;">
      <span></span><span></span><span></span>
    </div>

    <button class="scroll-to-bottom" id="scroll-to-bottom" title="Ir al final">‚Üì</button>

    <div class="input-container">
      <div class="input-wrapper">
        <input type="text" id="user-input" placeholder="Mensaje..." autocomplete="off" />
        <button class="send-button" id="send-btn">‚û§</button>
      </div>
    </div>
  </div>

  <script>
    const chatContainer = document.getElementById("chat-container");
    const minimizeBtn = document.getElementById("minimize-btn");
    const messagesContainer = document.getElementById("messages");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const typingIndicator = document.getElementById("typing");
    const scrollToBottomBtn = document.getElementById("scroll-to-bottom");

    let SESSION_ID = localStorage.getItem("novi_session_id");
    if (!SESSION_ID) {
      SESSION_ID = "s_" + Date.now() + "_" + Math.random().toString(36).slice(2, 10);
      localStorage.setItem("novi_session_id", SESSION_ID);
    }

    let isSending = false;
    let chatInitialized = false;

    // ===================================================
    // FUNCI√ìN DE SCROLL AUTOM√ÅTICO Y BOT√ìN
    // ===================================================
    
    function scrollToBottom(smooth = true) {
      messagesContainer.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: smooth ? 'smooth' : 'auto'
      });
    }

    function checkScrollPosition() {
      const isNearBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop - messagesContainer.clientHeight < 100;
      
      if (isNearBottom) {
        scrollToBottomBtn.classList.remove('show');
      } else {
        scrollToBottomBtn.classList.add('show');
      }
    }

    messagesContainer.addEventListener('scroll', checkScrollPosition);
    
    scrollToBottomBtn.addEventListener('click', () => {
      scrollToBottom(true);
    });

    // ===================================================
    // EFECTO DE ESCRITURA LETRA POR LETRA
    // ===================================================
    
    function typeWriter(element, text, speed = 20) {
      return new Promise((resolve) => {
        let i = 0;
        const container = document.createElement('span');
        container.className = 'typing-effect';
        element.appendChild(container);
        
        function type() {
          if (i < text.length) {
            container.innerHTML += text.charAt(i);
            i++;
            
            // Scroll autom√°tico mientras escribe
            if (i % 5 === 0) {
              scrollToBottom(false);
            }
            
            setTimeout(type, speed);
          } else {
            resolve();
          }
        }
        
        type();
      });
    }

    // ===================================================
    // FUNCIONES DE INDICADORES
    // ===================================================

    function showTyping() {
      typingIndicator.style.display = "block";
      scrollToBottom();
    }

    function hideTyping() {
      typingIndicator.style.display = "none";
    }

    // ===================================================
    // ACTIVAR BOTONES
    // ===================================================

    function activateQuickButtons(container) {
      // ‚úÖ Primero: botones con data-url (links externos)
      container.querySelectorAll(".quick-button[data-url]").forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener("click", function(e) {
          e.preventDefault();
          e.stopPropagation();
          const url = this.getAttribute("data-url");
          console.log("üîó Abriendo URL:", url);
          window.open(url, "_blank");
        });
      });

      // ‚úÖ Segundo: botones con data-option (flujo conversacional)
      container.querySelectorAll(".quick-button[data-option]").forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener("click", function(e) {
          e.preventDefault();
          e.stopPropagation();
          const option = this.getAttribute("data-option");
          console.log("üîò Opci√≥n clickeada:", option);
          
          if (option === "authorize") {
            sendAuthorization();
          } else {
            addMessage(this.textContent, true);
            sendToChatbot(option);
          }
        });
      });
    }

    // ===================================================
    // AGREGAR MENSAJE CON EFECTO TYPING
    // ===================================================

    async function addMessage(content, isUser = false) {
      const div = document.createElement("div");
      div.classList.add("message", isUser ? "user-message" : "bot-message");
      
      if (isUser) {
        div.innerHTML = content;
        messagesContainer.appendChild(div);
        scrollToBottom();
      } else {
        // Efecto de escritura para mensajes del bot
        messagesContainer.appendChild(div);
        
        // Extraer HTML vs texto plano
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = content;
        
        // Si tiene botones o HTML complejo, mostrarlo directo
        const hasButtons = content.includes('<button') || content.includes('<div');
        
        if (hasButtons) {
          div.innerHTML = content;
          scrollToBottom();
        } else {
          // Efecto typing para texto simple
          await typeWriter(div, tempDiv.textContent);
          scrollToBottom();
        }
      }

      setTimeout(() => activateQuickButtons(div), 50);
    }

    // ===================================================
    // ENVIAR A CHATBOT
    // ===================================================

    async function sendToChatbot(message) {
      if (isSending) {
        console.log("‚è≥ Ya hay un env√≠o en proceso");
        return;
      }
      
      isSending = true;
      console.log("üì§ Enviando:", message);
      showTyping();

      try {
        const res = await fetch("/api/chatbot/chatbot", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message, sessionId: SESSION_ID })
        });

        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        
        const data = await res.json();
        console.log("üì• Respuesta:", data);
        hideTyping();

        if (data.sessionId) {
          SESSION_ID = data.sessionId;
          localStorage.setItem("novi_session_id", SESSION_ID);
        }

        if (data.reply) {
          await addMessage(data.reply);
        } else {
          await addMessage("‚ö†Ô∏è No recib√≠ respuesta del servidor");
        }
        
      } catch (err) {
        hideTyping();
        await addMessage("‚ùå Error: " + err.message);
        console.error("Error completo:", err);
      } finally {
        isSending = false;
      }
    }

    // ===================================================
    // ENVIAR MENSAJE USUARIO
    // ===================================================

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      await addMessage(message, true);
      userInput.value = "";
      await sendToChatbot(message);
    }

    // ===================================================
    // AUTORIZACI√ìN
    // ===================================================

    window.sendAuthorization = async function() {
      const checkbox = document.getElementById("authCheck");
      if (checkbox && !checkbox.checked) {
        alert("‚ö†Ô∏è Por favor marca la casilla de autorizaci√≥n");
        return;
      }

      if (isSending) return;
      isSending = true;
      showTyping();

      try {
        const res = await fetch("/api/chatbot/authorize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ sessionId: SESSION_ID })
        });

        const data = await res.json();
        hideTyping();
        await addMessage(data.reply);
      } catch (err) {
        hideTyping();
        await addMessage("‚ùå Error procesando autorizaci√≥n");
        console.error(err);
      } finally {
        isSending = false;
      }
    };

    // ===================================================
    // MINIMIZAR
    // ===================================================

    minimizeBtn.addEventListener("click", () => {
      chatContainer.style.display = "none";
      if (window.parent !== window) {
        window.parent.postMessage({ action: 'closeChat' }, '*');
      }
    });

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", e => { 
      if (e.key === "Enter") sendMessage(); 
    });

    // ===================================================
    // INICIALIZAR CHAT AUTOM√ÅTICAMENTE
    // ===================================================

    window.addEventListener('load', async () => {
      setTimeout(async () => {
        if (!chatInitialized) {
          chatInitialized = true;
          await sendToChatbot("start");
          userInput.focus();
        }
      }, 300);
    });

    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('init') === 'start' && !chatInitialized) {
      chatInitialized = true;
      setTimeout(() => sendToChatbot("start"), 500);
    }
  </script>
</body>
</html>